    // Calculate total payments for a given month
    // NOW: Only counts COMPLETED/EARNED payments up to TODAY (not projected to end of month)
    // Returns detailed breakdown with projections
    calculateMonthlyPayments: async (employees, logs, referenceDate) => {
        const month = referenceDate.getMonth();
        const year = referenceDate.getFullYear();
        const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let totalEarned = 0;
        let totalProjected = 0;
        let salaryEarned = 0;
        let salaryProjected = 0;

        // Method 1: Sum up all work logs with payAmount (for manual/hourly employees)
        const monthLogs = logs.filter(l => l.date.startsWith(monthStr));
        
        // Add manual employee payments from work logs
        const manualPayments = monthLogs
            .filter(l => {
                const emp = employees.find(e => e.id === l.employeeId);
                return emp && (!emp.paymentMode || emp.paymentMode === 'manual');
            })
            .reduce((sum, log) => sum + (log.payAmount || 0), 0);
        
        totalEarned += manualPayments;
        totalProjected += manualPayments; // For manual, earned = projected (already happened)

        // Method 2: Calculate COMPLETED payment cycles for salary employees (UP TO TODAY)
        const salaryEmployees = employees.filter(e => e.paymentMode === 'salary');
        
        for (const emp of salaryEmployees) {
            if (!emp.startDate || !emp.baseSalary) continue;

            const startDate = new Date(emp.startDate);
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);

            // Only count if employee started before or during this month
            if (startDate > monthEnd) continue;

            const freq = emp.paymentFrequency || 'monthly';
            const cycleAmount = freq === 'weekly' ? (emp.baseSalary / 4) :
                               freq === 'biweekly' ? (emp.baseSalary / 2) :
                               emp.baseSalary;

            let cyclesCompleted = 0; // Up to TODAY
            let cyclesProjected = 0; // Total for the month

            if (freq === 'weekly') {
                const weekStartDay = await window.Utils.getWeekStartDay();
                
                // Find all week start dates in the month
                let currentDate = new Date(monthStart);
                while (currentDate <= monthEnd) {
                    const dayOfWeek = currentDate.getDay();
                    
                    if (dayOfWeek === weekStartDay && currentDate >= startDate) {
                        // This week started in the month AND after employee started
                        cyclesProjected++;
                        
                        // Week end is 6 days after start
                        const weekEnd = new Date(currentDate);
                        weekEnd.setDate(currentDate.getDate() + 6);
                        
                        // Only count as COMPLETED if week end has PASSED
                        if (weekEnd <= today) {
                            cyclesCompleted++;
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else if (freq === 'biweekly') {
                // Biweekly: 15th and end of month
                const mid = new Date(year, month, 15);
                const end = new Date(year, month + 1, 0);
                
                // Check 15th payment
                if (mid >= startDate && mid >= monthStart && mid <= monthEnd) {
                    cyclesProjected++;
                    if (mid <= today) cyclesCompleted++;
                }
                
                // Check end of month payment
                if (end >= startDate) {
                    cyclesProjected++;
                    if (end <= today) cyclesCompleted++;
                }
            } else {
                // Monthly: one payment at end of month
                if (monthEnd >= startDate) {
                    cyclesProjected = 1;
                    if (monthEnd <= today) cyclesCompleted = 1;
                }
            }

            const earned = cyclesCompleted * cycleAmount;
            const projected = cyclesProjected * cycleAmount;
            
            salaryEarned += earned;
            salaryProjected += projected;
            totalEarned += earned;
            totalProjected += projected;
        }

        return {
            totalPaid: Math.round(totalEarned), // What's been EARNED up to today  
            totalProjected: Math.round(totalProjected), // What will be paid by end of month
            breakdown: {
                manual: Math.round(manualPayments),
                salaryEarned: Math.round(salaryEarned),
                salaryProjected: Math.round(salaryProjected)
            },
            pending: Math.round(totalProjected - totalEarned) // What's still to be earned
        };
    },
